# 008: ReScript 実装前の追加論点（未経験者が詰まりやすい箇所）

- **status**: open
- **date**: 2026-02-08
- **participants**: ユーザー, Codex (GPT-5)
- **origin**: 実装着手前の追加論点洗い出し

## 背景

既存の論点（001〜007）と詳細設計で、MVP 方針と実装骨格は確定している。
一方で、ReScript 未経験者が実装開始時にハマりやすい運用・境界条件がいくつか残っている。

## ゴール

実装フェーズで手戻りや混乱を起こしやすい論点を先に明示し、短サイクルで決定できる状態にする。

## 追加で議論したい論点

### 1. テスト実行契約の統一（`bun test` / `vitest` / `*_test.res`）

- 現状:
  - 議論ログでは CI を `bun test` 前提としている（001, 005）
  - 実装設定は `package.json` で `vitest run`
  - テスト命名規約は `*_test.res`（007）
- 懸念:
  - ランナーのファイル探索規約と命名規約が一致せず、テストが拾われない可能性
- 決めること:
  - CI/ローカルで実行する「唯一の正」となるコマンド
  - そのコマンドで確実にテスト検出される命名規約

### 2. ドキュメント間の構成ズレ（`tests/` vs `test/`、命名）

- 現状:
  - `rescript.json` は `tests/` を参照
  - 設計ドキュメントの一部は `test/` 表記
  - 007 は `ConfluenceXxx` 命名を採用、別ドキュメントは `Types`/`XmlParser` 命名
- 懸念:
  - 初回実装者がどの構成を正として作業すべきか迷う
- 決めること:
  - 現時点の canonical なディレクトリ/命名規約
  - ドキュメント同期の更新順序

### 3. Markdown エスケープ規則の固定

- 現状:
  - 詳細設計に「未決事項」として残っている（`|`, `*` など）
- 懸念:
  - テスト期待値が揺れ、fixture の再生成が頻発する
- 決めること:
  - MVP でエスケープ対象にする文字
  - コンテキスト別ルール（通常段落、テーブルセル、リンクテキスト、コード内）

### 4. 空白・改行の正規化ルールの固定

- 現状:
  - 詳細設計に「未決事項」として残っている
- 懸念:
  - XML の空白差分で Markdown 出力が不安定になり、回帰テストが壊れやすい
- 決めること:
  - 連続空白・改行の扱い
  - 要素境界での trim 方針
  - `LineBreak` と段落境界の優先順位

### 5. htmlparser2 FFI 境界の型方針（`Nullable.t` / `option`）

- 現状:
  - FFI は概略のみで、実装ルールが未固定
- 懸念:
  - ReScript 初学者が `Nullable.t` と `option` の変換責務で混乱しやすい
- 決めること:
  - FFI 層の返却型方針（生の `Nullable` をどこまで許容するか）
  - 境界で `option` に正規化するレイヤー

### 6. `exception` と JS `Error` の boundary 運用規約

- 現状:
  - 設計は確定（内部 exception、公開 boundary で JS Error 化）
- 懸念:
  - どの層で throw/catch するかが曖昧だと、重複変換や握りつぶしが発生する
- 決めること:
  - `ConvertError` を生成してよいモジュール
  - catch して JS `Error` に変換する唯一の場所
  - それ以外の層での例外再送出ルール

## 期待するアウトプット

1. 上記 6 論点のうち、実装着手に直結する項目（1, 3, 4, 5）を優先順位付きで決定する
2. 決定内容を既存設計ドキュメントへ同期する順序を決める
3. 「この状態なら Phase 3a 実装に迷わず入れる」という完了条件を明文化する

## ステータス

未決（次ラウンドで収束）
